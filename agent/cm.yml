apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-agent-config
  namespace: grafana-labs
data:
  agent.yaml: |
    server:
      http_listen_port: 12345
    loki:
      configs:
        - name: loki-all-pods
          clients:
            - url: ${LOKI_HOSTNAME}
          scrape_configs:
            - job_name: kubernetes-pods-name
              kubernetes_sd_configs:
                - role: pod
              pipeline_stages:
                - docker: {}
              relabel_configs:
                - source_labels:
                    - __meta_kubernetes_pod_label_name
                  target_label: __service__
                - source_labels:
                    - __meta_kubernetes_pod_node_name
                  target_label: __host__
                - action: drop
                  regex: ""
                  source_labels:
                    - __service__
                - action: labelmap
                  regex: __meta_kubernetes_pod_label_(.+)
                - action: replace
                  replacement: $1
                  separator: /
                  source_labels:
                    - __meta_kubernetes_namespace
                    - __service__
                  target_label: job
                - action: replace
                  source_labels:
                    - __meta_kubernetes_namespace
                  target_label: namespace
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_name
                  target_label: pod
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_container_name
                  target_label: container
                - replacement: /var/log/pods/*$1/*.log
                  separator: /
                  source_labels:
                    - __meta_kubernetes_pod_uid
                    - __meta_kubernetes_pod_container_name
                  target_label: __path__
            - job_name: kubernetes-pods-app
              kubernetes_sd_configs:
                - role: pod
              pipeline_stages:
                - docker: {}
              relabel_configs:
                - action: drop
                  regex: .+
                  source_labels:
                    - __meta_kubernetes_pod_label_name
                - source_labels:
                    - __meta_kubernetes_pod_label_app
                  target_label: __service__
                - source_labels:
                    - __meta_kubernetes_pod_node_name
                  target_label: __host__
                - action: drop
                  regex: ""
                  source_labels:
                    - __service__
                - action: labelmap
                  regex: __meta_kubernetes_pod_label_(.+)
                - action: replace
                  replacement: $1
                  separator: /
                  source_labels:
                    - __meta_kubernetes_namespace
                    - __service__
                  target_label: job
                - action: replace
                  source_labels:
                    - __meta_kubernetes_namespace
                  target_label: namespace
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_name
                  target_label: pod
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_container_name
                  target_label: container
                - replacement: /var/log/pods/*$1/*.log
                  separator: /
                  source_labels:
                    - __meta_kubernetes_pod_uid
                    - __meta_kubernetes_pod_container_name
                  target_label: __path__
            - job_name: kubernetes-pods-direct-controllers
              kubernetes_sd_configs:
                - role: pod
              pipeline_stages:
                - docker: {}
              relabel_configs:
                - action: drop
                  regex: .+
                  separator: ""
                  source_labels:
                    - __meta_kubernetes_pod_label_name
                    - __meta_kubernetes_pod_label_app
                - action: drop
                  regex: '[0-9a-z-.]+-[0-9a-f]{8,10}'
                  source_labels:
                    - __meta_kubernetes_pod_controller_name
                - source_labels:
                    - __meta_kubernetes_pod_controller_name
                  target_label: __service__
                - source_labels:
                    - __meta_kubernetes_pod_node_name
                  target_label: __host__
                - action: drop
                  regex: ""
                  source_labels:
                    - __service__
                - action: labelmap
                  regex: __meta_kubernetes_pod_label_(.+)
                - action: replace
                  replacement: $1
                  separator: /
                  source_labels:
                    - __meta_kubernetes_namespace
                    - __service__
                  target_label: job
                - action: replace
                  source_labels:
                    - __meta_kubernetes_namespace
                  target_label: namespace
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_name
                  target_label: pod
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_container_name
                  target_label: container
                - replacement: /var/log/pods/*$1/*.log
                  separator: /
                  source_labels:
                    - __meta_kubernetes_pod_uid
                    - __meta_kubernetes_pod_container_name
                  target_label: __path__
            - job_name: kubernetes-pods-indirect-controller
              kubernetes_sd_configs:
                - role: pod
              pipeline_stages:
                - docker: {}
              relabel_configs:
                - action: drop
                  regex: .+
                  separator: ""
                  source_labels:
                    - __meta_kubernetes_pod_label_name
                    - __meta_kubernetes_pod_label_app
                - action: keep
                  regex: '[0-9a-z-.]+-[0-9a-f]{8,10}'
                  source_labels:
                    - __meta_kubernetes_pod_controller_name
                - action: replace
                  regex: ([0-9a-z-.]+)-[0-9a-f]{8,10}
                  source_labels:
                    - __meta_kubernetes_pod_controller_name
                  target_label: __service__
                - source_labels:
                    - __meta_kubernetes_pod_node_name
                  target_label: __host__
                - action: drop
                  regex: ""
                  source_labels:
                    - __service__
                - action: labelmap
                  regex: __meta_kubernetes_pod_label_(.+)
                - action: replace
                  replacement: $1
                  separator: /
                  source_labels:
                    - __meta_kubernetes_namespace
                    - __service__
                  target_label: job
                - action: replace
                  source_labels:
                    - __meta_kubernetes_namespace
                  target_label: namespace
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_name
                  target_label: pod
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_container_name
                  target_label: container
                - replacement: /var/log/pods/*$1/*.log
                  separator: /
                  source_labels:
                    - __meta_kubernetes_pod_uid
                    - __meta_kubernetes_pod_container_name
                  target_label: __path__
            - job_name: kubernetes-pods-static
              kubernetes_sd_configs:
                - role: pod
              pipeline_stages:
                - docker: {}
              relabel_configs:
                - action: drop
                  regex: ""
                  source_labels:
                    - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_label_component
                  target_label: __service__
                - source_labels:
                    - __meta_kubernetes_pod_node_name
                  target_label: __host__
                - action: drop
                  regex: ""
                  source_labels:
                    - __service__
                - action: labelmap
                  regex: __meta_kubernetes_pod_label_(.+)
                - action: replace
                  replacement: $1
                  separator: /
                  source_labels:
                    - __meta_kubernetes_namespace
                    - __service__
                  target_label: job
                - action: replace
                  source_labels:
                    - __meta_kubernetes_namespace
                  target_label: namespace
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_name
                  target_label: pod
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_container_name
                  target_label: container
                - replacement: /var/log/pods/*$1/*.log
                  separator: /
                  source_labels:
                    - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror
                    - __meta_kubernetes_pod_container_name
                  target_label: __path__
      positions_directory: /tmp/positions
    prometheus:
      configs:
        - name: agent
          host_filter: false
          remote_write:
            - url: ${GEM_URL}
              basic_auth:
                username: ${GEM_USERNAME}
                password: ${GEM_PASSWORD}
          scrape_configs:
            - job_name: pods-scraped-by-agent
              kubernetes_sd_configs:
                - role: pod
              relabel_configs:
                - action: drop
                  regex: "false"
                  source_labels:
                    - __meta_kubernetes_pod_annotation_prometheus_io_scrape
                - action: drop
                  regex: Succeeded|Failed
                  source_labels:
                    - __meta_kubernetes_pod_phase
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_annotation_prometheus_io_scheme
                  target_label: __scheme__
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_annotation_prometheus_io_path
                  target_label: __metrics_path__
                - action: replace
                  regex: (.+?)(\:\d+)?;(\d+)
                  replacement: $1:$3
                  source_labels:
                    - __address__
                    - __meta_kubernetes_pod_annotation_prometheus_io_port
                  target_label: __address__
                - action: replace
                  source_labels:
                    - __meta_kubernetes_namespace
                  target_label: namespace
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_name
                  target_label: pod
      global:
        scrape_interval: 15s
      wal_directory: /var/lib/agent/data  
    integrations:
      node_exporter:
        enabled: true
        rootfs_path: /
        sysfs_path: /sys
        procfs_path: /proc
    tempo:
      configs:
      - name: jaeger-only
        batch:
            send_batch_size: 1000
            timeout: 5s
        receivers:
          zipkin:
          jaeger:
            protocols:
              thrift_http: null
        remote_write:
          - endpoint: tempo:3100