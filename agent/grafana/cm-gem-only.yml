apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-agent-config
  namespace: agent
data:
  agent.yaml: |
    server:
      http_listen_port: 12345
    prometheus:
      configs:
        - name: agent
          host_filter: true
          remote_write:
            - url: http://gem-enterprise-metrics-gateway.gem.svc.cluster.local:8080/api/v1/push
              basic_auth:
                username: grafana-enterprise
                password: Z3JhZmFuYS1lbnRlcnByaXNlLWFnZW50LWZvcmV2ZXI6PiMsbjI3OTR1OTV7ITU0fnwvVTAlP04w
          scrape_configs:
            - job_name: grafana-enterprise-pods
              metrics_path: "/metrics"
              kubernetes_sd_configs:
                - role: pod
                  namespaces:
                    names:
                      - grafana-enterprise
              relabel_configs:
                - action: drop
                  regex: Succeeded|Failed
                  source_labels:
                    - __meta_kubernetes_pod_phase
                - action: keep
                  regex: 3000
                  source_labels:
                    - __meta_kubernetes_pod_container_port_number
                - action: replace
                  source_labels:
                    - __meta_kubernetes_namespace
                  target_label: namespace
                - action: replace
                  source_labels:
                    - __meta_kubernetes_pod_name
                  target_label: pod
      global:
        scrape_interval: 15s
      wal_directory: /var/lib/agent/data
